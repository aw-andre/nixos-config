#!/usr/bin/env bash

TUI=("vim" "nvim" "gemini" "lldb" "gdb")
ARGS=()

# Read options
if [[ "$1" == "-w" ]]; then

  if [[ -z "$WAYLAND_DISPLAY" || "$WAYLAND_DISPLAY" == "wayland-0" ]]; then
    echo "No display!"
    exit 1
  fi

  WINDOW="$2"
  shift 2
fi

ARGS+=("$@")
BIN="${ARGS[0]}"
CMD="$(printf '%q ' "${ARGS[@]}")"

# Get existing windows before launch (for workspace moving)
if [[ -v WINDOW ]]; then
  EXISTING_WINDOWS=$(hyprctl clients -j | jq -r '.[].address')
  PREV=$(hyprctl activeworkspace -j | jq -r '.id')
fi

# Launch command
(
  if [[ "${TUI[*]}" =~ $BIN ]]; then
    kitty -e zsh -ci "eval $CMD"
  else
    eval "$CMD"
  fi

  if [[ -v WINDOW ]]; then
    hyprctl dispatch workspace "$PREV"
  fi
) &>/dev/null &
disown

# Move to workspace if specified
if [[ -v WINDOW ]]; then
  # Wait for any new window to appear
  until NEW_WINDOW=$(hyprctl clients -j | jq -r '.[].address' | grep -v -F "$EXISTING_WINDOWS" | head -1) && [[ -n "$NEW_WINDOW" ]]; do
    sleep 0.05
  done
  hyprctl dispatch movetoworkspacesilent "$WINDOW",address:"$NEW_WINDOW" &>/dev/null
fi
